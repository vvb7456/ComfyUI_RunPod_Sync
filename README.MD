# RunPod ComfyUI Automation Script (v3.2)

é’ˆå¯¹ RunPod ç¯å¢ƒå®šåˆ¶çš„ ComfyUI å…¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ã€‚é›†æˆ SageAttention åŠ é€Ÿï¼ˆé€‚é… Wan2.2ï¼‰ã€CivitDL å¹¶è¡Œä¸‹è½½ä¸è‡ªåŠ¨åˆ†ç±»ã€Rclone åŒå‘åŒæ­¥åŠŸèƒ½ã€‚

## 1. ç¯å¢ƒè¦æ±‚

å¿…é¡»ä½¿ç”¨ä»¥ä¸‹ RunPod å®˜æ–¹åŸºç¡€é•œåƒï¼Œå¦åˆ™æ— æ³•ä¿è¯ CUDA/Python ç‰ˆæœ¬å…¼å®¹æ€§ï¼š

*   **Docker Image**: `runpod/pytorch:1.0.2-cu1281-torch280-ubuntu2404`
*   **Python**: 3.12 (é•œåƒè‡ªå¸¦)
*   **CUDA**: 12.8 (System) / 12.4 (Torch) - *è„šæœ¬åŒ…å«è‡ªåŠ¨ä¿®è¡¥é€»è¾‘*
*   **GPU**: æ”¯æŒ Ampere (A100/3090), Ada (4090), Blackwell (sm_100/120) æ¶æ„

## 2. æ ¸å¿ƒåŠŸèƒ½

### ğŸš€ æé€Ÿæ¨ç†
*   **SageAttention V2**: è‡ªåŠ¨è¯†åˆ« GPU ç®—åŠ› (sm_xx) å¹¶ä»æºç ç¼–è¯‘ï¼Œæ˜¾è‘—ä¼˜åŒ– Wan2.1 ç­‰ Transformer æ¨¡å‹æ€§èƒ½ã€‚
*   **Torch 2.x + FlashAttn**: é›†æˆ Flash Attention 2 å’Œ xformersï¼Œå¼ºåˆ¶ä¿®è¡¥ PyTorch CUDA ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶ã€‚

### ğŸ“¦ æ™ºèƒ½èµ„æºç®¡ç† (CivitDL v3)
*   **å¹¶è¡Œä¸‹è½½**: é€šè¿‡ `civitdl` æ‰¹é‡å¹¶å‘ä¸‹è½½æ¨¡å‹ï¼Œè·‘æ»¡æœºæˆ¿å¸¦å®½ã€‚
*   **è‡ªåŠ¨åˆ†ç±»**: å†…ç½® Python Sorterï¼Œæ ¹æ®å…ƒæ•°æ®è‡ªåŠ¨å°† Checkpoint, LoRA, VAE, ControlNet åˆ†æµè‡³ ComfyUI å¯¹åº”ç›®å½•ã€‚
*   **å…äº¤äº’è®¤è¯**: è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶æ³¨å…¥ API Keyï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

### ğŸ”„ æ•°æ®åŒæ­¥
*   **R2/S3 è¾“å…¥**: å¯åŠ¨æ—¶ä»å¯¹è±¡å­˜å‚¨æ‹‰å–ç§æœ‰å·¥ä½œæµå’Œ LoRAã€‚
*   **OneDrive è¾“å‡º**: åå°ç›‘æ§ `/output` ç›®å½•ï¼Œç”Ÿæˆçš„å›¾ç‰‡/è§†é¢‘è‡ªåŠ¨ä¸Šä¼ è‡³ OneDriveã€‚
*   **Tmux å®ˆæŠ¤**: æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ Tmux ä¼šè¯ä¸­ï¼ŒSSH æ–­å¼€ä¸å½±å“è¿è¡Œã€‚

## 3. é…ç½®å‚æ•° (Environment Variables)

åœ¨ RunPod æ¨¡æ¿ä¸­è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡å | å¿…å¡« | ç¤ºä¾‹/è¯´æ˜ |
| :--- | :--- | :--- |
| `CIVITAI_TOKEN` | æ˜¯ | CivitAI API Keyï¼Œç”¨äºä¸‹è½½æ¨¡å‹ (Settings -> API Key)ã€‚ |
| `ALL_MODEL_IDS` | å¦ | é€—å·åˆ†éš”çš„æ¨¡å‹ ID (Model ID æˆ– Version ID)ã€‚æ”¯æŒæ··åˆè¾“å…¥ Checkpoint/LoRA/ControlNetï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åˆ†ç±»ã€‚<br>ä¾‹: `12345,67890,102030` |
| `RCLONE_CONF_BASE64` | å¦ | Base64 ç¼–ç åçš„ `rclone.conf` æ–‡ä»¶å†…å®¹ (ç”Ÿæˆæ–¹æ³•è§ä¸‹æ–‡)ã€‚ |
| `R2_REMOTE_NAME` | å¦ | Rclone é…ç½®ä¸­ R2 å­˜å‚¨æ¡¶çš„åç§°ï¼Œç”¨äºæ‹‰å–ç§æœ‰èµ„æºã€‚ |
| `ONEDRIVE_REMOTE_NAME` | å¦ | Rclone é…ç½®ä¸­ OneDrive çš„åç§°ï¼Œç”¨äºä¸Šä¼ äº§å‡ºç‰©ã€‚ |
| `PLUGIN_URLS` | å¦ | è‡ªå®šä¹‰æ’ä»¶ Git åœ°å€åˆ—è¡¨ï¼Œé€—å·åˆ†éš”ã€‚å¦‚ä¸å¡«åˆ™ä½¿ç”¨è„šæœ¬å†…ç½®çš„é»˜è®¤æ¨èåˆ—è¡¨ã€‚ |

> **å…¼å®¹æ€§è¯´æ˜**: æ—§ç‰ˆå˜é‡ `CHECKPOINT_IDS`, `LORA_IDS` ä¾ç„¶æœ‰æ•ˆï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å°†å…¶åˆå¹¶è‡³ `ALL_MODEL_IDS` å¤„ç†ã€‚

## 4. è®¾ç½®æŒ‡å—

### 4.1 è·å– Rclone Base64 é…ç½®
è„šæœ¬éœ€è¦æ— äº¤äº’è¯»å– Rclone é…ç½®ï¼Œè¯·åœ¨æœ¬åœ°æœºå™¨ï¼ˆæˆ–ä»»æ„å·²é…ç½®å¥½ Rclone çš„ç¯å¢ƒï¼‰æ‰§è¡Œï¼š

1.  é…ç½® Rclone (å¦‚æœªé…ç½®):
    ```bash
    rclone config
    # æŒ‰æç¤ºé…ç½®å¥½ R2 (source) å’Œ OneDrive (dest)
    ```
2.  å¯¼å‡º Base64 å­—ç¬¦ä¸²:
    ```bash
    # Linux/Mac
    cat ~/.config/rclone/rclone.conf | base64 -w 0
    
    # Windows PowerShell
    [Convert]::ToBase64String([IO.File]::ReadAllBytes("$env:USERPROFILE\.config\rclone\rclone.conf"))
    ```
3.  å¤åˆ¶è¾“å‡ºçš„é•¿å­—ç¬¦ä¸²ï¼Œå¡«å…¥ RunPod çš„ `RCLONE_CONF_BASE64` å˜é‡ã€‚

### 4.2 éƒ¨ç½²æ­¥éª¤

1.  **RunPod åå°**: Create Pod -> Select Templateã€‚
2.  **é€‰æ‹©é•œåƒ**: è¾“å…¥ `runpod/pytorch:1.0.2-cu1281-torch280-ubuntu2404`ã€‚
3.  **ç¼–è¾‘ç¯å¢ƒå˜é‡**: å¡«å…¥ä¸Šè¿° API Token å’Œæ¨¡å‹ IDã€‚
4.  **å¡«å…¥å¯åŠ¨è„šæœ¬**:
    å°† `setup.sh` çš„å†…å®¹ç²˜è´´è‡³ **Container Start Command** (Docker Command) ä¸­ã€‚
    *æˆ–è€…*
    å°†è„šæœ¬æ‰˜ç®¡åœ¨ Gist/Githubï¼Œå¡«å…¥:
    ```bash
    bash -c "$(wget -qO- https://your-gist-url/setup.sh)"
    ```
5.  **å¯åŠ¨**: ç­‰å¾…çº¦ 3-5 åˆ†é’Ÿï¼ˆè§†æ¨¡å‹ä¸‹è½½é‡è€Œå®šï¼‰ã€‚

### 4.3 éªŒè¯è¿è¡Œ

SSH è¿æ¥åˆ° Pod åï¼š

*   **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**:
    ```bash
    tail -f /workspace/setup.log
    ```
*   **æŸ¥çœ‹ ComfyUI æœåŠ¡**:
    ```bash
    tmux attach -t comfy
    ```
*   **æŸ¥çœ‹åŒæ­¥æœåŠ¡**:
    ```bash
    tmux attach -t sync
    ```

## 5. ç›®å½•ç»“æ„è¯´æ˜

è„šæœ¬è¿è¡Œåï¼Œ`/workspace/ComfyUI/models` å°†å‘ˆç°å¦‚ä¸‹ç»“æ„ï¼ˆç”± Sorter è‡ªåŠ¨æ•´ç†ï¼‰ï¼š

```text
/models
â”œâ”€â”€ checkpoints/
â”‚   â””â”€â”€ [Wan2.1_Model_Name]/       # Checkpoint æ–‡ä»¶
â”œâ”€â”€ loras/
â”‚   â””â”€â”€ [Detail_Tweaker]/          # LoRA æ–‡ä»¶ + é¢„è§ˆå›¾
â”œâ”€â”€ controlnet/
â”œâ”€â”€ vae/
â””â”€â”€ ...